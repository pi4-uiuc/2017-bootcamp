---
title: "5. Databases and SQL"
author: "David LeBauer"
date: '2017-05-30'
slug: databases-and-sql
tags: [r]
---



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<iframe src="https://docs.google.com/presentation/d/1dQHlodU9PggM7khqlL_OS4P-X-o96D78ihuvuD2Iong/embed?start=false&amp;loop=false&amp;delayms=3000" frameborder="0" width="960" height="749" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true">
</iframe>
</div>
<div id="spreadsheets-and-tables" class="section level2">
<h2>Spreadsheets and Tables</h2>
<p>A database is a generic term for data. Often these are divided into ‘relational’ and ‘non-relational’… We will get to these later. First, lets start with Spreadsheets, which are a simple, and very common format for data.</p>
<p>In fact, so far we have been working with tables.</p>
</div>
<div id="miscanthus-yields" class="section level2">
<h2>Miscanthus Yields</h2>
<p><a href="https://docs.google.com/spreadsheets/d/1MNG5BH6oDaRH4Ii1ZO7tVRV7pTZRKPv81In1NFdLFbs/edit#gid=0" class="uri">https://docs.google.com/spreadsheets/d/1MNG5BH6oDaRH4Ii1ZO7tVRV7pTZRKPv81In1NFdLFbs/edit#gid=0</a></p>
</div>
<div id="sorghum-data-from-arizona" class="section level2">
<h2>Sorghum Data from Arizona</h2>
<p>Lets start with a spreadsheet that was prepared by a colleague of mine, Maria Newcomb, in Arizona</p>
<p><a href="https://docs.google.com/spreadsheets/d/1ESwAR2-BpQ2HfaCoSDCQaiBJVab_5sHawEltyYcLP8U/edit#gid=932079509" class="uri">https://docs.google.com/spreadsheets/d/1ESwAR2-BpQ2HfaCoSDCQaiBJVab_5sHawEltyYcLP8U/edit#gid=932079509</a></p>
<p>Let’s review the pages</p>
<ul>
<li>README is good. They are well ahead of the curve on this!</li>
<li>What additional information is here?</li>
<li>Where is the data we want to look at?</li>
<li><p>What information is redundant</p></li>
<li><p>Download the table “PlantHeights_AllPlots” as CSV</p></li>
</ul>
</div>
<div id="data-cleaning" class="section level2">
<h2>Data Cleaning</h2>
<ul>
<li>In this lesson, we will use Open Refine to find errors, sort, and clean our dataset.</li>
<li>Open the OpenRefine container in the NDSLabs workbench</li>
</ul>
<div id="about-open-refine" class="section level3">
<h3>About Open Refine</h3>
<p>This tutorial is based on the <a href="http://www.datacarpentry.org/OpenRefine-ecology-lesson/01-working-with-openrefine/">Data Carpentry Open Refine for Ecology lesson</a>, modified to use our datasets.</p>
<p>You can learn more about and download Open Refine at <a href="https://openrefine.org">openrefine.org</a>.</p>
</div>
<div id="importing-data-into-open-refine" class="section level3">
<h3>Importing Data into Open Refine</h3>
<p>Once OpenRefine is launched in your browser, the left margin has options to Create Project, Open Project, or Import Project. Here we will create a new project:</p>
<ul>
<li>click ‘Create Project’; ‘Get data from This Computer’ should be selected</li>
<li>what other ways can you get data into OpenRefine?</li>
<li>Click Choose Files and select the file <code>DRAFT_Sorghum2_PlantHeights_AugustPlanting-training-sample - PlantHeights_AllPlots.csv</code></li>
<li>Click Open –&gt; Next</li>
<li>OpenRefine gives you a preview - a chance to show you it understood the file.</li>
<li>did the file show up sensibly?</li>
<li>in the upper right corner create a meaninful project name and then click “Create Project”</li>
</ul>
</div>
<div id="faceting" class="section level3">
<h3>Faceting</h3>
<p>OpenRefine supports faceted browsing. This allows you tosee the big picture of your data and then filter down to a subset of rows. Once you have a target set of rows, you can apply changes in bulk.</p>
<ul>
<li>lets work with one of the columns containing plant height measurements</li>
<li>next to one of the numeric columns (Plant_ht_Aug24) click the arrow</li>
<li>facet –&gt; Numeric facet.
<ul>
<li>what went wrong?</li>
</ul></li>
<li>click ‘edit cells’ –&gt; common transforms –&gt; numeric</li>
<li>now try to click facet –&gt; numeric again
<ul>
<li>what do you see this time?</li>
<li>How is a numeric facet different than a text facet?</li>
</ul></li>
<li>click Plant_ht_Sep15
<ul>
<li>how many rows are there with non-numeric data?</li>
<li>what to do here?</li>
</ul></li>
</ul>
<p>Lets look at the Genotype field</p>
<ul>
<li>select the arrow next to the column named “Genotype”</li>
<li>select “Facet” –&gt; “Text Facet”</li>
<li>sort by “count”</li>
<li>what do you notice?</li>
<li>What is the level of replication in this study?</li>
<li>Which genotypes are not like the others?</li>
<li>why are there so many Genotypes named “Great Scott” and “border”?</li>
<li>Lets clean up all whitespace problems</li>
<li>trim leading and trailing whitespace</li>
<li>trim consecutive white space</li>
<li>now how many groups do we have?</li>
<li>Edit “border” –&gt; “Border”</li>
</ul>
</div>
<div id="terra-ref-sites-and-variables" class="section level3">
<h3>TERRA REF Sites and Variables</h3>
<p>Your turn:</p>
<p>Lets review a few datasets from the TERRA REF trait database. These are provided in the .json format by default:</p>
<ol style="list-style-type: decimal">
<li>Look at the sites table. Where are the sites? Are there redundant names?</li>
</ol>
<ul>
<li>import from <a href="https://terraref.ncsa.illinois.edu/bety/api/beta/sites?key=9999999999999999999999999999999999999999&amp;limit=none" class="uri">https://terraref.ncsa.illinois.edu/bety/api/beta/sites?key=9999999999999999999999999999999999999999&amp;limit=none</a></li>
<li>when you review the data, select the lowest level of hierarchy so column names aren’t long concatenations of the entire tree.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>See if you can find any redundant variables<br />
</li>
</ol>
<ul>
<li>import from <a href="https://terraref.ncsa.illinois.edu/bety/api/beta/variables.xml?key=9999999999999999999999999999999999999999&amp;limit=none" class="uri">https://terraref.ncsa.illinois.edu/bety/api/beta/variables.xml?key=9999999999999999999999999999999999999999&amp;limit=none</a></li>
<li>note that this is an XML format (the BETYdb API provide json, xml, and csv)</li>
</ul>
<div id="open-refine" class="section level4">
<h4>Open Refine</h4>
<ul>
<li>Lets look at the Miscanthus Yield dataset again</li>
<li>Open –&gt; Create Project –&gt; From URL</li>
<li>Enter <a href="https://www.betydb.org/search.csv?search=Ayield" class="uri">https://www.betydb.org/search.csv?search=Ayield</a></li>
<li>What is the matter here? Lets clean up the imported dataset.</li>
<li>columns are csv</li>
<li>discard first 8 lines, parse next 1 line as column headers</li>
<li>also, ‘parse cells to numbers, dates, etc’</li>
<li>Create Project</li>
</ul>
</div>
<div id="from-a-web-interface" class="section level4">
<h4>From a Web Interface</h4>
<p>Go to <a href="https://betydb.org">betydb.org</a> and enter “Miscanthus Yield” into the search box and click the search glass icon.</p>
<p>Lets review the information in this table.</p>
<ul>
<li>Site with city</li>
<li>Date + time + timezone</li>
<li>Species + common name</li>
<li>Cultivar</li>
<li>Trait</li>
<li>Mean (with units)</li>
<li>Method</li>
<li>Entity</li>
</ul>
<p>Now click the “Download Results” button. This will download a .csv file. A .csv file is a table where each column is defined by a comma, e.g. a 3x3 matrix would be formatted thus:</p>
<pre><code>row 1 col 1, row 1 col 2, row 1 col 3
row 2 col 1, row 2 col 2, row 2 col 3
row 3 col 1, row 3 col 2, row 3 col 3</code></pre>
<p><em>a brief note about csv files</em></p>
<p>By default, many computers will open the csv file directly into a <a href="https://en.wikipedia.org/wiki/spreadsheet">spreadsheet program</a> like Microsoft Excel or OpenOffice Calc. But because it is a text file, you can also open it in a <a href="https://en.wikipedia.org/wiki/Text_editor">text editor</a> like Notepad, nano, or emacs.</p>
<p>It can also be easily read by any software or parsed at the command line using tools like <code>cut</code> and <code>sed</code>. Unlike xml and json, it is more intuitive for a human to read.</p>
<blockquote>
<p>where are redundancies?</p>
</blockquote>
<ul>
<li>Site + city + lat + lon</li>
<li>Date + time + timezone</li>
<li>genus + scientificname + common name</li>
<li>Cultivar</li>
<li>Trait + units &amp; description</li>
<li>Mean</li>
<li>Method</li>
<li>Entity</li>
</ul>
</div>
</div>
<div id="tidy-data" class="section level3">
<h3>Tidy data</h3>
<ul>
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
<li>Each type of observational unit forms a table.</li>
</ul>
<p>From <a href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">tidyr vignette</a></p>
<blockquote>
<p>YOUR TURN Is the Miscanthus dataset tidy? What would we need to do to make it tidy?</p>
</blockquote>
</div>
</div>
<div id="relational-databases-and-sql" class="section level2">
<h2>Relational Databases and SQL</h2>
<div id="data-normalization" class="section level3">
<h3>Data Normalization</h3>
<p>“Codd’s Normal Forms” from (Codd 1970)</p>
<blockquote>
<p>process of organizing the columns (attributes) and tables (relations) of a relational database to reduce data redundancy and improve data integrity. <a href="https://en.wikipedia.org/wiki/Database_normalization">Wikipedia - Database normalization</a></p>
</blockquote>
<p>To motivate the use of a relational databases, lets start by looking at a table. Is there redundant information (that violates the )</p>
<blockquote>
<p>YOUR TURN: which of these fields has redundant data?</p>
</blockquote>
<ul>
<li>SQL allows us to select and group subsets of data, do math and other calculations, and combine data.</li>
<li>A relational database is made up of tables which are related to each other by shared keys.</li>
<li>primary keys</li>
<li>foreign keys</li>
<li>natural keys</li>
<li>Different database management systems (DBMS) use slightly different vocabulary, but they are all based on the same ideas.</li>
</ul>
<p>^^ from <a href="http://www.datacarpentry.org/sql-ecology-lesson/00-sql-introduction/">Data Carpentry</a> &gt; how would you begin to normalize this data set?</p>
</div>
<div id="lets-look-at-the-underlying-database" class="section level3">
<h3>Lets look at the underlying database</h3>
<div id="connecting-to-a-database-server" class="section level4">
<h4>Connecting to a database server</h4>
<p>connection parameters:</p>
<ul>
<li>host</li>
<li>login</li>
<li>user</li>
<li>database (database name)</li>
</ul>
<p>Lets connect to the terraref instance of betydb. Until now we have been accessing betydb.org. Now we will access (a copy of) the database behind terraref.ncsa.illinois.edu/bety</p>
<pre><code>Host: terra-bety.default
Port: 5432
User: bety
Password: bety
DB: bety</code></pre>
<p>From the command line:</p>
<pre class="sh"><code>psql -U bety -d bety -h terra-bety.default</code></pre>
<p>The hidden .pgpass file:</p>
<pre class="sh"><code>echo &quot;terra-bety.default:5432:bety:bety:bety&quot; &gt;&gt; ~/.pgpass
chmod 0600 ~/.pgpass # why?
psql </code></pre>
<p>Open the PostgreSQL application in the NDSLabs workbench and enter the connection parameters above.</p>
<p>Connection for use in R and Rmarkdown</p>
<pre class="r"><code>library(RPostgreSQL)</code></pre>
<pre><code>## Loading required package: methods</code></pre>
<pre><code>## Loading required package: DBI</code></pre>
<pre class="r"><code>dbcon &lt;- dbConnect(RPostgreSQL::PostgreSQL(),
                dbname = &quot;bety&quot;, 
                password = &#39;bety&#39;, 
                host = &#39;terra-bety.default&#39;, 
                user = &#39;bety&#39;, 
                port = 5432)</code></pre>
</div>
</div>
<div id="tables-schemas" class="section level3">
<h3>Tables &amp; Schemas</h3>
<div class="figure">
<img src="https://raw.githubusercontent.com/ebimodeling/betydb_manuscript/master/figures/gcbb12420-fig-0001.png" alt="A simplified entity–relationship diagram for key tables in Biofuel Ecophysiological Traits and Yields database (BETYdb)." />
<p class="caption">A simplified entity–relationship diagram for key tables in Biofuel Ecophysiological Traits and Yields database (BETYdb).</p>
</div>
<p>Here is a more comprehensive entity-relationship diagram:</p>
<div class="figure">
<img src="https://raw.githubusercontent.com/PecanProject/betydb-data-access/master/betydb_schema.png" alt="BETYdb Schema ER diagram" />
<p class="caption">BETYdb Schema ER diagram</p>
</div>
</div>
<div id="sql" class="section level3">
<h3>SQL</h3>
<p>Lets start using some basic SQL Commands</p>
<pre class="sql"><code>SELECT
WHERE
JOIN
DISTINCT
LIMIT
ORDER BY
GROUP BY
AND
OR
MIN
MAX
AVG
SUM
COUNT
LIKE</code></pre>
<pre class="sql"><code>select * from traits limit 10;
select * from traits where mean &lt; 0;</code></pre>
<pre class="sql"><code>select distinct trait from traits_and_yields_view;</code></pre>
<div class="knitsql-table">
<table>
<caption><span id="tab:distinct">Table 1: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">trait</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sv_area</td>
</tr>
<tr class="even">
<td align="left">height</td>
</tr>
<tr class="odd">
<td align="left">panicle_height</td>
</tr>
<tr class="even">
<td align="left">perimeter</td>
</tr>
<tr class="odd">
<td align="left">leaf_width</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
</tr>
<tr class="odd">
<td align="left">emergence_count</td>
</tr>
<tr class="even">
<td align="left">spike_height</td>
</tr>
<tr class="odd">
<td align="left">hull_area</td>
</tr>
<tr class="even">
<td align="left">tv_area</td>
</tr>
</tbody>
</table>
</div>
<pre class="sql"><code>select sitename, count(*) as n
   from traits_and_yields_view 
   group by sitename order by n desc;</code></pre>
<div class="knitsql-table">
<table>
<caption><span id="tab:sql-group-order">Table 2: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">sitename</th>
<th align="right">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Danforth Plant Science Center Bellweather Phenotyping Facility</td>
<td align="right">5490</td>
</tr>
<tr class="even">
<td align="left">MAC Field Scanner Field Plot 565 Season 2</td>
<td align="right">4474</td>
</tr>
<tr class="odd">
<td align="left">MAC Field Scanner Field Plot 556 Season 2</td>
<td align="right">4217</td>
</tr>
<tr class="even">
<td align="left">MAC Field Scanner Field Plot 557 Season 2</td>
<td align="right">3979</td>
</tr>
<tr class="odd">
<td align="left">MAC Field Scanner Field Plot 566 Season 2</td>
<td align="right">3833</td>
</tr>
<tr class="even">
<td align="left">MAC Field Scanner Field Plot 567 Season 2</td>
<td align="right">3742</td>
</tr>
<tr class="odd">
<td align="left">MAC Field Scanner Field Plot 564 Season 2</td>
<td align="right">3712</td>
</tr>
<tr class="even">
<td align="left">MAC Field Scanner Field Plot 558 Season 2</td>
<td align="right">3666</td>
</tr>
<tr class="odd">
<td align="left">MAC Field Scanner Field Plot 563 Season 2</td>
<td align="right">3659</td>
</tr>
<tr class="even">
<td align="left">MAC Field Scanner Field Plot 555 Season 2</td>
<td align="right">3648</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="types-of-joins" class="section level3">
<h3>Types of Joins</h3>
<div class="figure">
<img src="http://r4ds.had.co.nz/diagrams/join-venn.png" alt="types of joins" />
<p class="caption">types of joins</p>
</div>
<p>From <a href="http://r4ds.had.co.nz/relational-data.html">Grolemund and Wickham “R for Data Science”</a></p>
<pre class="sql"><code>select name, units, date, mean from traits left join variables 
   on traits.variable_id = variables.id
   where variables.name = &#39;NDVI&#39;</code></pre>
<div class="knitsql-table">
<table>
<caption><span id="tab:NDVI">Table 3: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">units</th>
<th align="left">date</th>
<th align="right">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.09779</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.01321</td>
</tr>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.11550</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.03440</td>
</tr>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.02625</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.11210</td>
</tr>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.04800</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-09-08 07:00:00</td>
<td align="right">0.29210</td>
</tr>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-09-08 07:00:00</td>
<td align="right">0.28910</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-09-08 07:00:00</td>
<td align="right">0.36270</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>YOUR TURN: write queries that will 1. to join the sites table to the traits table 2. join the managements table to the traits table</p>
</blockquote>
</div>
<div id="other-handy-features" class="section level3">
<h3>Other handy features</h3>
<div id="quality-control" class="section level4">
<h4>Quality control</h4>
<p>Lets look at this in the PostgreSQL studio</p>
<ul>
<li>constraints</li>
<li>foreign key</li>
<li>primary key</li>
<li>uniqueness</li>
<li>check</li>
<li>data types</li>
<li>numeric, int,</li>
<li>character, enum</li>
<li>geometry</li>
<li>natural keys</li>
</ul>
</div>
<div id="with" class="section level4">
<h4>With</h4>
<pre class="sql"><code>With NDVI as 
  (select name, units, date, mean from traits left join variables 
     on traits.variable_id = variables.id
     where variables.name = &#39;NDVI&#39;
  )
  select * from NDVI;</code></pre>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-2">Table 4: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">units</th>
<th align="left">date</th>
<th align="right">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.09779</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.01321</td>
</tr>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.11550</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.03440</td>
</tr>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.02625</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.11210</td>
</tr>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-08-08 07:00:00</td>
<td align="right">0.04800</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-09-08 07:00:00</td>
<td align="right">0.29210</td>
</tr>
<tr class="odd">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-09-08 07:00:00</td>
<td align="right">0.28910</td>
</tr>
<tr class="even">
<td align="left">NDVI</td>
<td align="left">ratio</td>
<td align="left">2016-09-08 07:00:00</td>
<td align="right">0.36270</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="views" class="section level4">
<h4>Views</h4>
<ul>
<li>Views (stored queries)</li>
<li>Materialized views (pre-computed queries)</li>
</ul>
<pre class="sql"><code>drop view if exists NDVI;

create view NDVI as
select * from traits_and_yields_view_private 
    where trait = &#39;NDVI&#39;;

select * from NDVI;</code></pre>
</div>
</div>
</div>
<div id="database-management-systems" class="section level2">
<h2>Database Management Systems</h2>
<div id="common-software" class="section level3">
<h3>Common software</h3>
<p>MySQL, PostgreSQL, Oracle, Access(?!)</p>
</div>
<div id="r-rpostgresql-and-dplyr" class="section level3">
<h3>R: RPostgreSQL and dplyr</h3>
<pre class="r"><code>library(RPostgreSQL)
dbcon &lt;- dbConnect(RPostgreSQL::PostgreSQL(),
                dbname = &quot;bety&quot;, password = &#39;bety&#39;, host = &#39;terra-bety.default&#39;, user = &#39;bety&#39;, port = 5432)

query &lt;- &quot;select * from traits left join variables 
             on traits.variable_id = variables.id
             where variables.name = &#39;NDVI&#39;;&quot;


result &lt;- dbSendQuery(dbcon, query)
df &lt;- fetch(result)
dbClearResult(result)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>#dbDisconnect(dbcon)</code></pre>
<pre class="sql"><code>select count(*) from traitsview_private;
</code></pre>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-3">Table 5: </span>1 records</caption>
<thead>
<tr class="header">
<th align="left">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">763852</td>
</tr>
</tbody>
</table>
</div>
<div id="connecting-with-dplyr" class="section level4">
<h4>Connecting with dplyr</h4>
<p>advantage for larger datasets: can do a lot of server-side summarization and some computing before pulling data into memory.</p>
<p><a href="https://cran.r-project.org/web/packages/dplyr/vignettes/databases.html" class="uri">https://cran.r-project.org/web/packages/dplyr/vignettes/databases.html</a></p>
<pre class="r"><code>library(dplyr)</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre class="r"><code>bety_src &lt;- src_postgres(dbname = &quot;bety&quot;, password = &#39;bety&#39;, host = &#39;terra-bety.default&#39;, user = &#39;bety&#39;, port = 5432)


#translate_sql()</code></pre>
<pre class="r"><code>treatments &lt;- tbl(bety_src, &#39;treatments&#39;) %&gt;% 
  select(treatment_id = id , name, definition, control)

managements_treatments &lt;- tbl(bety_src, &#39;managements_treatments&#39;)

managements &lt;- tbl(bety_src, &#39;managements&#39;) %&gt;% 
  filter(mgmttype %in% c(&#39;Fertilization_N&#39;, &#39;Planting&#39;, &#39;Irrigation&#39;)) %&gt;% 
  select(management_id = id, date, mgmttype, level, units) %&gt;% 
  left_join(managements_treatments, by = &#39;management_id&#39;) %&gt;% 
  left_join(treatments, by = &#39;treatment_id&#39;)

planting &lt;-managements %&gt;% 
  filter(mgmttype == &quot;Planting&quot;) %&gt;% 
  select(treatment_id, planting_date = date, nrate = level)

heights &lt;- tbl(bety_src, &#39;traits_and_yields_view&#39;) %&gt;% 
  filter(trait %in% c(&#39;plant_height&#39;, &#39;canopy_height&#39;)) %&gt;% 
  left_join(planting, by = &#39;treatment_id&#39;) %&gt;%  
  collect %&gt;% 
  mutate(age = as.Date(raw_date) - planting_date) 

library(ggplot2)
ggplot(data = heights, aes(raw_date, mean)) +
  geom_point(alpha = 0.1) + 
  facet_wrap(~trait, scales = &#39;free&#39;)</code></pre>
<pre><code>## Warning: Removed 7020 rows containing missing values (geom_point).</code></pre>
<p><img src="/post/2017-05-30-databases-and-sql_files/figure-html/complex-query-1.png" width="672" /></p>
</div>
</div>
<div id="apis" class="section level3">
<h3>APIs</h3>
<ul>
<li>sign into terraref.ncsa.illinois.edu/bety</li>
<li>username: <code>pi4-student</code></li>
<li>password: <code>ask-instructor</code> <!--pi4student!!--></li>
<li><p>locate your API key and copy it <!-- sSJzqPF77rRus9BGOZS4T76fzNhQ5Nk01tjcf1Bh--></p></li>
<li>see <a href="https://github.com/terraref/tutorials/blob/master/traits/00-BETYdb-getting-started.Rmd">terraref tutorials 01- betydb getting started</a></li>
<li><p>API Documentation terraref.ncsa.illinois.edu/bety/api/beta/docs</p></li>
</ul>
<div id="restful-interface" class="section level4">
<h4>restful interface</h4>
<p>get put delete <a href="https://en.wikipedia.org/wiki/Representational_state_transfer" class="uri">https://en.wikipedia.org/wiki/Representational_state_transfer</a></p>
</div>
<div id="json-data-structures" class="section level4">
<h4>json data structures</h4>
</div>
</div>
<div id="r-traits-package" class="section level3">
<h3>R traits package</h3>
<p>Example: query indoor data from terraref database using the R traits package:</p>
<p><a href="https://github.com/terraref/tutorials/blob/master/traits/02-danforth-phenotyping-facility.Rmd" class="uri">https://github.com/terraref/tutorials/blob/master/traits/02-danforth-phenotyping-facility.Rmd</a></p>
</div>
</div>
<div id="real-world-examples" class="section level2">
<h2>Real World Examples</h2>
<div id="advanced-betydb" class="section level3">
<h3>Advanced: BETYdb</h3>
<ul>
<li>Full Schema betydb.org/schemas</li>
<li>How would you query all of the planting dates associated with a trait record?</li>
</ul>
</div>
</div>
<div id="real-world-application-the-biofuel-ecophysiological-traits-and-yields-database" class="section level2">
<h2>Real World Application: the Biofuel Ecophysiological Traits and Yields database</h2>
<p>We have created ‘views’ to make it easier to query data from multiple tables. For example, to lookup the name and location of a site or the names and units of variables. The following query joins multiple tables, and is based on the yieldsview table:</p>
<pre class="sql"><code>SELECT &#39;yields&#39;::character(10) AS result_type,
    yields.id,
    yields.citation_id,
    yields.site_id,
    yields.treatment_id,
    sites.sitename,
    sites.city,
    st_y(st_centroid(sites.geometry)) AS lat,
    st_x(st_centroid(sites.geometry)) AS lon,
    species.scientificname,
    species.commonname,
    species.genus,
    species.id AS species_id,
    yields.cultivar_id,
    citations.author,
    citations.year AS citation_year,
    treatments.name AS treatment,
    yields.date,
    date_part(&#39;month&#39;::text, yields.date) AS month,
    date_part(&#39;year&#39;::text, yields.date) AS year,
    variables.name AS trait,
    variables.description AS trait_description,
    yields.mean,
    variables.units,
    yields.n,
    yields.statname,
    yields.stat,
    yields.notes,
   FROM ((((((yields
     LEFT JOIN sites ON ((yields.site_id = sites.id)))
     LEFT JOIN species ON ((yields.specie_id = species.id)))
     LEFT JOIN citations ON ((yields.citation_id = citations.id)))
     LEFT JOIN treatments ON ((yields.treatment_id = treatments.id)))
     LEFT JOIN variables ON (((variables.name)::text = &#39;Ayield&#39;::text)))
     LEFT JOIN users ON ((yields.user_id = users.id)));
     </code></pre>
<p>For more information, see the <a href="https://pecan.gitbooks.io/betydb-data-access/content/sqlqueries.html">BETYdb data access documentation</a></p>
</div>
<div id="references-and-further-reading" class="section level2">
<h2>references and further reading</h2>
<ul>
<li><a href="https://www.dataquest.io/blog/sql-basics/" class="uri">https://www.dataquest.io/blog/sql-basics/</a></li>
<li>Codd, E.F. (June 1970). “A Relational Model of Data for Large Shared Data Banks”. Communications of the ACM. 13 (6): 377–387. <a href="doi:10.1145/362384.362685" class="uri">doi:10.1145/362384.362685</a>.</li>
</ul>
</div>
